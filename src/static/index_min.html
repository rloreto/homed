<style>@import url(https://fonts.googleapis.com/css?family=Open+Sans:300);body{background-color:#CCC}#thermostat{width:50vmin;height:50vmin;margin:0 auto;-webkit-tap-highlight-color:transparent}.dial{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.dial.away .dial__ico__leaf{visibility:hidden}.dial.away .dial__lbl--target{visibility:hidden}.dial.away .dial__lbl--target--half{visibility:hidden}.dial.away .dial__lbl--away{opacity:1}.dial .dial__shape{-webkit-transition:fill .5s;transition:fill .5s}.dial__ico__leaf{fill:#13EB13;opacity:0;-webkit-transition:opacity .5s;transition:opacity .5s;pointer-events:none}.dial.has-leaf .dial__ico__leaf{display:block;opacity:1;pointer-events:initial}.dial__editableIndicator{fill:#fff;fill-rule:evenodd;opacity:0;-webkit-transition:opacity .5s;transition:opacity .5s}.dial--edit .dial__editableIndicator{opacity:1}.dial--state--off .dial__shape{fill:#222}.dial--state--heating .dial__shape{fill:#E36304}.dial--state--cooling .dial__shape{fill:#007AF1}.dial__ticks path{fill:rgba(255,255,255,.3)}.dial__ticks path.active{fill:rgba(255,255,255,.8)}.dial text{fill:#fff;text-anchor:middle;font-family:Helvetica,sans-serif;alignment-baseline:central}.dial__lbl--target{font-size:120px;font-weight:700}.dial__lbl--target--half{font-size:40px;font-weight:700;opacity:0;-webkit-transition:opacity .1s;transition:opacity .1s}.dial__lbl--target--half.shown{opacity:1;-webkit-transition:opacity 0s;transition:opacity 0s}.dial__lbl--ambient{font-size:22px;font-weight:700}.dial__lbl--away{font-size:72px;font-weight:700;opacity:0;pointer-events:none}#controls{font-family:Open Sans;background-color:rgba(255,255,255,.25);padding:20px;border-radius:5px;position:absolute;left:50%;-webkit-transform:translatex(-50%);transform:translatex(-50%);margin-top:20px}#controls label{text-align:left;display:block}#controls label span{display:inline-block;width:200px;text-align:right;font-size:.8em;text-transform:uppercase}#controls p{margin:0;margin-bottom:1em;padding-bottom:1em;border-bottom:2px solid #ccc}.button{border:none;color:#fff;padding:15px 32px;text-align:center;text-decoration:none;display:inline-block;font-size:16px;margin:4px 2px;cursor:pointer}.center{margin:auto;width:50%}.turnOn{background-color:#E36304;color:#fff}.turnOff{background-color:#222;color:#fff}</style><div id=container><div id=thermostat></div><div style=text-align:center><button class="button turnOn"id=turnOn>Encender</button></div><div style=text-align:center><button class="button turnOff"id=turnOff>Apagar</button></div></div><script>var thermostatDial=function(){function e(e,a,n){var r=document.createElementNS("http://www.w3.org/2000/svg",e);return t(r,a),n&&n.appendChild(r),r}function t(e,t){for(var a in t)e.setAttribute(a,t[a])}function a(e,t,a){var n=t*Math.PI/180,r=e[0]-a[0],i=e[1]-a[1],s=r*Math.cos(n)-i*Math.sin(n)+a[0],u=r*Math.sin(n)+i*Math.cos(n)+a[1];return[s,u]}function n(e,t,n){return e.map(function(e){return a(e,t,n)})}function r(e){return e.map(function(e,t){return(t>0?"L":"M")+e[0]+" "+e[1]}).join(" ")+"Z"}function i(e,t,a){return["M",e,",",t,"m",0-a,",",0,"a",a,",",a,0,1,",",0,2*a,",",0,"a",a,",",a,0,1,",",0,0-2*a,",",0,"z"].join(" ").replace(/\s,\s/g,",")}function s(e,t,a,n){return i(e,t,a)+" "+i(e,t,n)}function u(e,t,a){return e<t?t:e>a?a:e}function o(e){return Math.round(2*e)/2}function c(e,t,a){e.classList[a?"add":"remove"](t)}return function(i,d){function l(){g(),v(),m(),p(),f(),h()}function m(){var e,a;x.away?(e=x.ambient_temperature,a=e):(e=Math.min(x.ambient_temperature,x.target_temperature),a=Math.max(x.ambient_temperature,x.target_temperature));var i=u(Math.round((e-d.minValue)/D.rangeValue*d.numTicks),0,d.numTicks-1),s=u(Math.round((a-d.minValue)/D.rangeValue*d.numTicks),0,d.numTicks-1);E.forEach(function(e,a){var u=a==i||a==s,o=a>=i&&a<=s;t(e,{d:r(n(u?L:V,a*R-D.offsetDegrees,[D.radius,D.radius])),"class":o?"active":""})})}function f(){I.nodeValue=Math.floor(x.ambient_temperature),x.ambient_temperature%1!=0&&(I.nodeValue+="âµ");var e=u(x.ambient_temperature,d.minValue,d.maxValue);degs=D.tickDegrees*(e-d.minValue)/D.rangeValue-D.offsetDegrees,e>x.target_temperature?degs+=8:degs-=8;var n=a(D.lblAmbientPosition,degs,[D.radius,D.radius]);t(C,{x:n[0],y:n[1]})}function p(){A.nodeValue=Math.floor(x.target_temperature),c(j,"shown",x.target_temperature%1!=0)}function h(){c(w,"has-leaf",x.has_leaf)}function v(){Array.prototype.slice.call(w.classList).forEach(function(e){e.match(/^dial--state--/)&&w.classList.remove(e)}),w.classList.add("dial--state--"+x.hvac_state)}function g(){w.classList[x.away?"add":"remove"]("away")}function T(e){return e.targetTouches&&e.targetTouches.length?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:[e.x,e.y]}function _(e){x.enabled&&(G=setTimeout(function(){c(w,"dial--edit",!0),z.inProgress=!0,z.startPoint=T(e),z.startTemperature=x.target_temperature||d.minValue,z.lockAxis=void 0},10))}function b(e){if(x.enabled){if(clearTimeout(G),c(w,"dial--edit",!1),!z.inProgress)return;z.inProgress=!1,x.target_temperature!=z.startTemperature&&"function"==typeof d.onSetTargetTemperature&&d.onSetTargetTemperature(x.target_temperature)}}function y(e){if(e.preventDefault(),x.enabled){if(!z.inProgress)return;var t,a=T(e),n=z.startPoint[1]-a[1],r=a[0]-z.startPoint[0];"x"==z.lockAxis?t=r:"y"==z.lockAxis?t=n:Math.abs(n)>D.dragLockAxisDistance?(z.lockAxis="y",t=n):Math.abs(r)>D.dragLockAxisDistance?(z.lockAxis="x",t=r):t=Math.abs(n)>Math.abs(r)?n:r;var i=t*O()/d.diameter*D.rangeValue;x.target_temperature=o(z.startTemperature+i)}}function k(e){return u(o(e),d.minValue,d.maxValue)}function O(){return d.diameter/i.clientWidth}var x=this;d=d||{},d={enabled:d.enabled||!0,diameter:d.diameter||400,minValue:d.minValue||10,maxValue:d.maxValue||30,numTicks:d.numTicks||150,onSetTargetTemperature:d.onSetTargetTemperature||function(){}};var D={tickDegrees:300,rangeValue:d.maxValue-d.minValue,radius:d.diameter/2,ticksOuterRadius:d.diameter/30,ticksInnerRadius:d.diameter/8,hvac_states:["off","heating","cooling"],dragLockAxisDistance:15};D.lblAmbientPosition=[D.radius,D.ticksOuterRadius-(D.ticksOuterRadius-D.ticksInnerRadius)/2],D.offsetDegrees=180-(360-D.tickDegrees)/2;var S={target_temperature:d.minValue,ambient_temperature:d.minValue,hvac_state:D.hvac_states[0],has_leaf:!1,away:!1,enabled:!0};Object.defineProperty(this,"target_temperature",{get:function(){return S.target_temperature},set:function(e){S.target_temperature=k(+e),l()}}),Object.defineProperty(this,"ambient_temperature",{get:function(){return S.ambient_temperature},set:function(e){S.ambient_temperature=o(+e),l()}}),Object.defineProperty(this,"hvac_state",{get:function(){return S.hvac_state},set:function(e){D.hvac_states.indexOf(e)>=0&&(S.hvac_state=e,l())}}),Object.defineProperty(this,"has_leaf",{get:function(){return S.has_leaf},set:function(e){S.has_leaf=!!e,l()}}),Object.defineProperty(this,"away",{get:function(){return S.away},set:function(e){S.away=!!e,l()}}),Object.defineProperty(this,"enabled",{get:function(){return S.enabled},set:function(e){S.enabled=!!e,l()}});for(var w=e("svg",{width:"100%",height:"100%",viewBox:"0 0 "+d.diameter+" "+d.diameter,"class":"dial"},i),M=(e("circle",{cx:D.radius,cy:D.radius,r:D.radius,"class":"dial__shape"},w),e("path",{d:s(D.radius,D.radius,D.radius-4,D.radius-8),"class":"dial__editableIndicator"},w),e("g",{"class":"dial__ticks"},w)),V=[[D.radius-1,D.ticksOuterRadius],[D.radius+1,D.ticksOuterRadius],[D.radius+1,D.ticksInnerRadius],[D.radius-1,D.ticksInnerRadius]],L=[[D.radius-1.5,D.ticksOuterRadius],[D.radius+1.5,D.ticksOuterRadius],[D.radius+1.5,D.ticksInnerRadius+20],[D.radius-1.5,D.ticksInnerRadius+20]],R=D.tickDegrees/d.numTicks,E=[],P=0;P<d.numTicks;P++)E.push(e("path",{d:r(V)},M));var F=e("text",{x:D.radius,y:D.radius,"class":"dial__lbl dial__lbl--target"},w),A=document.createTextNode("");F.appendChild(A);var j=e("text",{x:D.radius+D.radius/2.5,y:D.radius-D.radius/8,"class":"dial__lbl dial__lbl--target--half"},w),N=document.createTextNode("5");j.appendChild(N);var C=e("text",{"class":"dial__lbl dial__lbl--ambient"},w),I=document.createTextNode("");C.appendChild(I);var q=e("text",{x:D.radius,y:D.radius,"class":"dial__lbl dial__lbl--away"},w),H=document.createTextNode("AWAY");q.appendChild(H);var J=(e("path",{"class":"dial__ico__leaf"},w),D.radius/5/100),B=["M",3,84,"c",24,17,51,18,73,-6,"C",100,52,100,22,100,4,"c",-13,15,-37,9,-70,19,"C",4,32,0,63,0,76,"c",6,-7,18,-17,33,-23,24,-9,34,-9,48,-20,-9,10,-20,16,-43,24,"C",22,63,8,78,3,84,"z"].map(function(e){return isNaN(e)?e:e*J}).join(" "),X=[D.radius-100*J*.5,1.5*D.radius];e("path",{"class":"dial__ico__leaf",d:B,transform:"translate("+X[0]+","+X[1]+")"},w);l();var G,z={inProgress:!1,startPoint:null,startTemperature:0,lockAxis:void 0};w.addEventListener("mousedown",_),w.addEventListener("touchstart",_),w.addEventListener("mouseup",b),w.addEventListener("mouseleave",b),w.addEventListener("touchend",b),w.addEventListener("mousemove",y),w.addEventListener("touchmove",y)}}(),thermostatUrl="http://informfromdevice",isTurnOn,btnTurnOn=document.getElementById("turnOn"),btnTurnOff=document.getElementById("turnOff"),showThermostat=function(){var e=document.getElementById("container");e.style.visibility="visible"},hideThermostat=function(){var e=document.getElementById("container");e.style.visibility="hidden"};hideThermostat();var turnOn=function(){btnTurnOff.style.display="inline-block",btnTurnOn.style.display="none",setStateToDeviceFake(!1,function(){nest.away=!1,nest.hvac_state="heating",nest.enabled=!0})},turnOff=function(){btnTurnOff.style.display="none",btnTurnOn.style.display="inline-block",setStateToDeviceFake(!1,function(){nest.away=!0,nest.hvac_state="off",nest.enabled=!1})},nest=new thermostatDial(document.getElementById("thermostat"),{onSetTargetTemperature:function(e){nest.ambient_temperature<e?turnOn():turnOff(),setTargetTemperatureToDevice(e)}});btnTurnOn.addEventListener("click",function(){turnOn()}),btnTurnOff.addEventListener("click",function(){turnOff()}),setStateToDevice=function(e,t){var a=new XMLHttpRequest;a.open("POST","on",!0),a.setRequestHeader("Content-type","application/json"),a.onreadystatechange=function(){if(4===a.readyState&&200===a.status){var e=JSON.parse(a.responseText);e&&t&&t()}};var n=JSON.stringify({});a.send(n)},setStateToDeviceFake=function(e,t){t&&t()},setTargetTemperatureToDevice=function(e,t){var a=new XMLHttpRequest;a.open("POST","/api/temperature",!0),a.setRequestHeader("Content-type","application/json"),a.onreadystatechange=function(){if(4===a.readyState&&200===a.status){var e=JSON.parse(a.responseText);e&&t&&t()}};var n=JSON.stringify({temperature:e});a.send(n)},setTargetTemperatureToDeviceFake=function(e,t){t&&t()},setStateFromDevice=function(){var e=new XMLHttpRequest;e.open("GET","/api/state",!0),e.setRequestHeader("Content-type","application/json"),e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var t=JSON.parse(e.responseText);t.isOn?turnOn():turnOff()}},e.send()},setStateFromDeviceFake=function(){turnOff()},setAmbientTemperatureFromDevice=function(){var e=new XMLHttpRequest;e.open("GET","/api/temperature",!0),e.setRequestHeader("Content-type","application/json"),e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var t=JSON.parse(e.responseText);t.temperature&&(nest.ambient_temperature=t.temperature)}},e.send()},setAmbientTemperatureFromDeviceFake=function(){nest.ambient_temperature=21},setTargetTemperatureFromDevice=function(){var e=new XMLHttpRequest;e.open("GET","/api/temperature/target",!0),e.setRequestHeader("Content-type","application/json"),e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var t=JSON.parse(e.responseText);t.temperature&&(nest.target_temperature=t.temperature)}},e.send()},setTargetTemperatureFromDeviceFake=function(){nest.target_temperature=25},setStateFromDeviceFake(),setAmbientTemperatureFromDeviceFake(),setTargetTemperatureFromDeviceFake(),showThermostat()</script>
